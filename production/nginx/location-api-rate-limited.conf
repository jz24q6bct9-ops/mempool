# Rate-Limited API Location Configuration
#
# This file provides an example of how to apply rate limiting to your Mempool API endpoints.
# Include this AFTER location-api.conf in your nginx server block, or modify location-api.conf
# to include these rate limiting directives.
#
# To use this configuration:
# 1. Include http-rate-limit.conf in your nginx.conf http block
# 2. Include this file in your server block AFTER your main location-api.conf
# 3. Reload nginx: sudo nginx -t && sudo nginx -s reload

###########
# mempool #
###########

# WebSocket endpoint - moderate rate limit
location /api/v1/ws {
	limit_req zone=api_websocket burst=5 nodelay;
	
	# Continue with normal websocket handling
	try_files /dev/null @mempool-api-v1-websocket;
}

# Transaction broadcasting - strict rate limit
location /api/v1/tx {
	limit_req zone=api_broadcast burst=3 nodelay;
	
	# Continue with normal handling
	try_files /dev/null @mempool-api-v1-cache-disabled;
}

# Expensive address and transaction lookups - stricter rate limit
location ~* ^/api/v1/(address|txs)/ {
	limit_req zone=api_expensive burst=5 nodelay;
	
	# Continue with normal handling
	try_files /dev/null @mempool-api-v1-cache-normal;
}

# Block data queries - stricter rate limit for bulk operations
location ~* ^/api/v1/blocks/ {
	limit_req zone=api_expensive burst=10 nodelay;
	
	# Continue with normal handling
	try_files /dev/null @mempool-api-v1-cache-normal;
}

# General API endpoints - standard rate limit
location /api/v1 {
	limit_req zone=api_general burst=20 nodelay;
	
	# Continue with normal handling
	try_files /dev/null @mempool-api-v1-cache-normal;
}

###########
# esplora #
###########

# Esplora API endpoints - standard rate limit
location /api/ {
	limit_req zone=api_general burst=20 nodelay;
	
	rewrite ^/api/(.*) /$1 break;
	try_files /dev/null @esplora-api-cache-minimal;
}

# Note: These rate limits are applied IN ADDITION to the cache configurations
# defined in location-api.conf. The cache helps reduce load on your backend,
# while rate limiting prevents abuse even for cached responses.

# Adjust the rates and burst values based on your needs:
# - Higher rates for public explorers with good infrastructure
# - Lower rates for personal/private instances with limited resources
# - Monitor your logs and adjust as needed
